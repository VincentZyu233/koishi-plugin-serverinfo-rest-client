import { Context, h } from 'koishi'
import { Config } from '../config'
import {
  ApiClient,
  resolveOutputModes,
  formatTimestamp,
  getTypstRenderer,
  buildTypstTheme,
  escapeTypstText,
} from '../index'

interface HealthResponse {
  status: string
  timestamp: number
  uptime: number
}

function formatTextOutput(data: HealthResponse, label: string): string {
  return `${label} â¤ï¸ å¥åº·æ£€æŸ¥

ğŸ“Š çŠ¶æ€: ${data.status === 'healthy' ? 'âœ… å¥åº·' : 'âŒ å¼‚å¸¸'}
â° æ—¶é—´æˆ³: ${formatTimestamp(data.timestamp)}
â±ï¸ è¿è¡Œæ—¶é—´: ${formatUptime(data.uptime)}`
}

function formatUptime(ms: number): string {
  const seconds = Math.floor(ms / 1000)
  const minutes = Math.floor(seconds / 60)
  const hours = Math.floor(minutes / 60)
  const days = Math.floor(hours / 24)
  
  if (days > 0) {
    return `${days}å¤© ${hours % 24}å°æ—¶ ${minutes % 60}åˆ†é’Ÿ`
  } else if (hours > 0) {
    return `${hours}å°æ—¶ ${minutes % 60}åˆ†é’Ÿ`
  } else if (minutes > 0) {
    return `${minutes}åˆ†é’Ÿ ${seconds % 60}ç§’`
  } else {
    return `${seconds}ç§’`
  }
}

function generateTypstCode(data: HealthResponse, theme: ReturnType<typeof buildTypstTheme>, label: string): string {
  const timestamp = new Date().toLocaleString('zh-CN')
  const statusEmoji = data.status === 'healthy' ? 'âœ…' : 'âŒ'
  const statusText = data.status === 'healthy' ? 'å¥åº·' : 'å¼‚å¸¸'

  return `#set page(
  width: 400pt,
  height: auto,
  margin: (x: 14pt, y: 14pt),
  fill: ${theme.pageBg}
)

#set text(
  font: ("${theme.fontFamily}", "Noto Sans CJK SC", "Microsoft YaHei"),
  size: 11pt,
  fill: ${theme.textColor},
  lang: "zh"
)

#align(center)[
  #block(
    fill: ${theme.headerFill},
    stroke: 2pt + ${theme.headerStroke},
    radius: 6pt,
    inset: 10pt,
    width: 100%
  )[
    #text(size: 16pt, weight: "bold", fill: ${theme.headerText})[
      ${escapeTypstText(label)} â¤ï¸ å¥åº·æ£€æŸ¥
    ]
  ]
]

#v(8pt)

#block(
  fill: ${theme.panelFill},
  stroke: 1pt + ${theme.panelStroke},
  radius: 4pt,
  inset: 12pt,
  width: 100%
)[
  #table(
    columns: (auto, 1fr),
    stroke: none,
    row-gutter: 8pt,
    
    text(weight: "bold", fill: ${theme.sectionTitle})[ğŸ“Š çŠ¶æ€],
    [${statusEmoji} ${escapeTypstText(statusText)}],
    
    text(weight: "bold", fill: ${theme.sectionTitle})[â° æ—¶é—´æˆ³],
    [${escapeTypstText(formatTimestamp(data.timestamp))}],
    
    text(weight: "bold", fill: ${theme.sectionTitle})[â±ï¸ è¿è¡Œæ—¶é—´],
    [${escapeTypstText(formatUptime(data.uptime))}],
  )
]

#v(8pt)

#align(center)[
  #text(size: 8pt, fill: ${theme.statsText})[
    Generated by serverinfo-rest-client Â· ${escapeTypstText(timestamp)}
  ]
]
`
}

export function registerHealthCommand(
  ctx: Context,
  cfg: Config,
  apiClient: ApiClient,
  logger: any,
  prefix: string,
  label: string
) {
  ctx.command(`${prefix}.health`, 'å¥åº·æ£€æŸ¥')
    .option('mode', '-m <mode:string> è¾“å‡ºæ¨¡å¼ (text/image)')
    .action(async ({ session, options }) => {
      try {
        const data = await apiClient.get<HealthResponse>('/health')
        const modes = resolveOutputModes(options.mode, cfg)

        const results: h[] = []

        for (const mode of modes) {
          if (mode === 'text') {
            results.push(h.text(formatTextOutput(data, label)))
          } else if (mode === 'typst-image') {
            try {
              const renderer = await getTypstRenderer(ctx, cfg, logger)
              const theme = buildTypstTheme(cfg)
              const typstCode = generateTypstCode(data, theme, label)
              const pngBuffer = await renderer.toPng(typstCode, cfg.typstRenderScale)
              results.push(h.image(pngBuffer, 'image/png'))
            } catch (err) {
              logger.warn(`Typst æ¸²æŸ“å¤±è´¥: ${err}`)
              results.push(h.text(`[Typst æ¸²æŸ“å¤±è´¥: ${err.message}]`))
            }
          }
        }

        if (cfg.quoteCommandReplies && session.messageId) {
          return h('', [h.quote(session.messageId), ...results])
        }
        return results
      } catch (error) {
        logger.error(`å¥åº·æ£€æŸ¥å¤±è´¥: ${error}`)
        return `âŒ å¥åº·æ£€æŸ¥å¤±è´¥: ${error.message}`
      }
    })
}
