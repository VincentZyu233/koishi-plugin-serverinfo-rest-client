import { Context, h } from 'koishi'
import { Config } from '../config'
import {
  ApiClient,
  resolveOutputModes,
  getTypstRenderer,
  buildTypstTheme,
  escapeTypstText,
} from '../index'

interface ServerResponse {
  bdsVersion: string
  protocolVersion: number
  onlinePlayers: number
  time: {
    daytime: number
    gametime: number
    day: number
  }
  weather: number
}

const WEATHER_MAP: Record<number, string> = {
  0: 'â˜€ï¸ æ™´å¤©',
  1: 'ğŸŒ§ï¸ é›¨å¤©',
  2: 'â›ˆï¸ é›·æš´',
}

function getWeatherText(weather: number): string {
  return WEATHER_MAP[weather] || `â“ æœªçŸ¥ (${weather})`
}

function formatTextOutput(data: ServerResponse): string {
  return `ğŸ–¥ï¸ æœåŠ¡å™¨è¯¦ç»†ä¿¡æ¯

ğŸ® BDS ç‰ˆæœ¬: ${data.bdsVersion}
ğŸ“¡ åè®®ç‰ˆæœ¬: ${data.protocolVersion}
ğŸ‘¥ åœ¨çº¿ç©å®¶: ${data.onlinePlayers}

â° æ—¶é—´ä¿¡æ¯:
  â€¢ ç™½å¤©æ—¶é—´: ${data.time.daytime}
  â€¢ æ¸¸æˆæ—¶é—´: ${data.time.gametime}
  â€¢ æ¸¸æˆå¤©æ•°: ç¬¬ ${data.time.day} å¤©

ğŸŒ¤ï¸ å¤©æ°”: ${getWeatherText(data.weather)}`
}

function generateTypstCode(data: ServerResponse, theme: ReturnType<typeof buildTypstTheme>): string {
  const timestamp = new Date().toLocaleString('zh-CN')

  return `#set page(
  width: 420pt,
  height: auto,
  margin: (x: 14pt, y: 14pt),
  fill: ${theme.pageBg}
)

#set text(
  font: ("${theme.fontFamily}", "Noto Sans CJK SC", "Microsoft YaHei"),
  size: 11pt,
  fill: ${theme.textColor},
  lang: "zh"
)

#align(center)[
  #block(
    fill: ${theme.headerFill},
    stroke: 2pt + ${theme.headerStroke},
    radius: 6pt,
    inset: 10pt,
    width: 100%
  )[
    #text(size: 16pt, weight: "bold", fill: ${theme.headerText})[
      ğŸ–¥ï¸ æœåŠ¡å™¨è¯¦ç»†ä¿¡æ¯
    ]
  ]
]

#v(8pt)

#block(
  fill: ${theme.panelFill},
  stroke: 1pt + ${theme.panelStroke},
  radius: 4pt,
  inset: 12pt,
  width: 100%
)[
  #text(weight: "bold", fill: ${theme.sectionTitle})[ğŸ“‹ åŸºæœ¬ä¿¡æ¯]
  #v(6pt)
  #table(
    columns: (auto, 1fr),
    stroke: none,
    row-gutter: 6pt,
    
    [ğŸ® BDS ç‰ˆæœ¬],
    [${escapeTypstText(data.bdsVersion)}],
    
    [ğŸ“¡ åè®®ç‰ˆæœ¬],
    [${data.protocolVersion}],
    
    [ğŸ‘¥ åœ¨çº¿ç©å®¶],
    [${data.onlinePlayers}],
    
    [ğŸŒ¤ï¸ å¤©æ°”],
    [${escapeTypstText(getWeatherText(data.weather))}],
  )
]

#v(8pt)

#block(
  fill: ${theme.panelFill},
  stroke: 1pt + ${theme.panelStroke},
  radius: 4pt,
  inset: 12pt,
  width: 100%
)[
  #text(weight: "bold", fill: ${theme.sectionTitle})[â° æ—¶é—´ä¿¡æ¯]
  #v(6pt)
  #table(
    columns: (auto, 1fr),
    stroke: none,
    row-gutter: 6pt,
    
    [â˜€ï¸ ç™½å¤©æ—¶é—´],
    [${data.time.daytime}],
    
    [ğŸ• æ¸¸æˆæ—¶é—´],
    [${data.time.gametime}],
    
    [ğŸ“… æ¸¸æˆå¤©æ•°],
    [ç¬¬ ${data.time.day} å¤©],
  )
]

#v(8pt)

#align(center)[
  #text(size: 8pt, fill: ${theme.statsText})[
    Generated by serverinfo-rest-client Â· ${escapeTypstText(timestamp)}
  ]
]
`
}

export function registerServerCommand(
  ctx: Context,
  cfg: Config,
  apiClient: ApiClient,
  logger: any
) {
  ctx.command('mcinfo.server', 'æœåŠ¡å™¨è¯¦ç»†ä¿¡æ¯')
    .option('mode', '-m <mode:string> è¾“å‡ºæ¨¡å¼ (text/image)')
    .action(async ({ session, options }) => {
      try {
        const data = await apiClient.get<ServerResponse>('/server')
        const modes = resolveOutputModes(options.mode, cfg)

        const results: h[] = []

        for (const mode of modes) {
          if (mode === 'text') {
            results.push(h.text(formatTextOutput(data)))
          } else if (mode === 'typst-image') {
            try {
              const renderer = await getTypstRenderer(ctx, cfg, logger)
              const theme = buildTypstTheme(cfg)
              const typstCode = generateTypstCode(data, theme)
              const pngBuffer = await renderer.toPng(typstCode, cfg.typstRenderScale)
              results.push(h.image(pngBuffer, 'image/png'))
            } catch (err) {
              logger.warn(`Typst æ¸²æŸ“å¤±è´¥: ${err}`)
              results.push(h.text(`[Typst æ¸²æŸ“å¤±è´¥: ${err.message}]\n\n${formatTextOutput(data)}`))
            }
          }
        }

        if (cfg.quoteCommandReplies && session.messageId) {
          return h('', [h.quote(session.messageId), ...results])
        }
        return results
      } catch (error) {
        logger.error(`è·å–æœåŠ¡å™¨è¯¦ç»†ä¿¡æ¯å¤±è´¥: ${error}`)
        return `âŒ è·å–æœåŠ¡å™¨è¯¦ç»†ä¿¡æ¯å¤±è´¥: ${error.message}`
      }
    })
}
