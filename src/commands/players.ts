import { Context, h } from 'koishi'
import { Config } from '../config'
import {
  ApiClient,
  resolveOutputModes,
  getTypstRenderer,
  buildTypstTheme,
  escapeTypstText,
} from '../index'

interface PlayerInfo {
  name: string
  xuid: string
  uuid: string
  permLevel: number
  gameMode: number
  health: number
  maxHealth: number
  pos: {
    x: number
    y: number
    z: number
    dimId: number
  }
  blockPos: {
    x: number
    y: number
    z: number
  }
  isOP: boolean
  isFlying: boolean
  isSneaking: boolean
  speed: number
  direction: object
  langCode: string
}

interface PlayersResponse {
  players: PlayerInfo[]
  count: number
}

const DIMENSION_MAP: Record<number, string> = {
  0: 'ğŸŒ ä¸»ä¸–ç•Œ',
  1: 'ğŸ”¥ ä¸‹ç•Œ',
  2: 'ğŸŒŒ æœ«åœ°',
}

const GAMEMODE_MAP: Record<number, string> = {
  0: 'ğŸ—¡ï¸ ç”Ÿå­˜',
  1: 'ğŸ¨ åˆ›é€ ',
  2: 'ğŸ¯ å†’é™©',
  3: 'ğŸ‘ï¸ æ—è§‚',
}

function getDimension(dimId: number): string {
  return DIMENSION_MAP[dimId] || `â“ æœªçŸ¥ (${dimId})`
}

function getGameMode(mode: number): string {
  return GAMEMODE_MAP[mode] || `â“ æœªçŸ¥ (${mode})`
}

function formatPlayerText(player: PlayerInfo, hideCoordinates: boolean): string {
  const flags: string[] = []
  if (player.isOP) flags.push('ğŸ‘‘ OP')
  if (player.isFlying) flags.push('ğŸ¦… é£è¡Œä¸­')
  if (player.isSneaking) flags.push('ğŸ æ½œè¡Œä¸­')

  const positionLine = hideCoordinates
    ? ''
    : `    â€¢ ä½ç½®: ${player.pos.x.toFixed(1)}, ${player.pos.y.toFixed(1)}, ${player.pos.z.toFixed(1)}\n`

  return `  ğŸ‘¤ ${player.name}
    â€¢ æ¨¡å¼: ${getGameMode(player.gameMode)}
    â€¢ ç”Ÿå‘½: ${player.health}/${player.maxHealth} â¤ï¸
${positionLine}    â€¢ ç»´åº¦: ${getDimension(player.pos.dimId)}
    ${flags.length > 0 ? `â€¢ çŠ¶æ€: ${flags.join(' | ')}` : ''}`
}

function formatTextOutput(data: PlayersResponse, hideCoordinates: boolean): string {
  if (data.count === 0) {
    return `ğŸ‘¥ ç©å®¶åˆ—è¡¨

å½“å‰æ²¡æœ‰ç©å®¶åœ¨çº¿`
  }

  const playerTexts = data.players.map(p => formatPlayerText(p, hideCoordinates)).join('\n\n')
  return `ğŸ‘¥ ç©å®¶åˆ—è¡¨ (${data.count} äººåœ¨çº¿)

${playerTexts}`
}

function generatePlayerTypstBlock(player: PlayerInfo, theme: ReturnType<typeof buildTypstTheme>, hideCoordinates: boolean): string {
  const flags: string[] = []
  if (player.isOP) flags.push('ğŸ‘‘ OP')
  if (player.isFlying) flags.push('ğŸ¦… é£è¡Œ')
  if (player.isSneaking) flags.push('ğŸ æ½œè¡Œ')

  const coordinateLine = hideCoordinates
    ? ''
    : `
  #v(4pt)
  #text(size: 9pt)[ğŸ“ ${player.pos.x.toFixed(1)}, ${player.pos.y.toFixed(1)}, ${player.pos.z.toFixed(1)}]`

  return `
#block(
  fill: ${theme.panelFill},
  stroke: 1pt + ${theme.panelStroke},
  radius: 4pt,
  inset: 10pt,
  width: 100%
)[
  #text(size: 12pt, weight: "bold", fill: ${theme.sectionTitle})[ğŸ‘¤ ${escapeTypstText(player.name)}]
  ${flags.length > 0 ? `#h(8pt) #text(size: 9pt)[${flags.join(' ')}]` : ''}
  #v(6pt)
  #grid(
    columns: (1fr, 1fr),
    gutter: 6pt,
    [ğŸ® ${escapeTypstText(getGameMode(player.gameMode))}],
    [â¤ï¸ ${player.health}/${player.maxHealth}],
    [${escapeTypstText(getDimension(player.pos.dimId))}],
    [ğŸƒ é€Ÿåº¦: ${player.speed.toFixed(1)}],
  )${coordinateLine}
]
`
}

function generateTypstCode(data: PlayersResponse, theme: ReturnType<typeof buildTypstTheme>, hideCoordinates: boolean): string {
  const timestamp = new Date().toLocaleString('zh-CN')

  if (data.count === 0) {
    return `#set page(
  width: 400pt,
  height: auto,
  margin: (x: 14pt, y: 14pt),
  fill: ${theme.pageBg}
)

#set text(
  font: ("${theme.fontFamily}", "Noto Sans CJK SC", "Microsoft YaHei"),
  size: 11pt,
  fill: ${theme.textColor},
  lang: "zh"
)

#align(center)[
  #block(
    fill: ${theme.headerFill},
    stroke: 2pt + ${theme.headerStroke},
    radius: 6pt,
    inset: 10pt,
    width: 100%
  )[
    #text(size: 16pt, weight: "bold", fill: ${theme.headerText})[
      ğŸ‘¥ ç©å®¶åˆ—è¡¨
    ]
  ]
]

#v(8pt)

#block(
  fill: ${theme.panelFill},
  stroke: 1pt + ${theme.panelStroke},
  radius: 4pt,
  inset: 12pt,
  width: 100%
)[
  #align(center)[
    #text(size: 12pt)[å½“å‰æ²¡æœ‰ç©å®¶åœ¨çº¿]
  ]
]

#v(8pt)

#align(center)[
  #text(size: 8pt, fill: ${theme.statsText})[
    Generated by serverinfo-rest-client Â· ${escapeTypstText(timestamp)}
  ]
]
`
  }

  const playerBlocks = data.players.map(p => generatePlayerTypstBlock(p, theme, hideCoordinates)).join('\n#v(6pt)\n')

  return `#set page(
  width: 450pt,
  height: auto,
  margin: (x: 14pt, y: 14pt),
  fill: ${theme.pageBg}
)

#set text(
  font: ("${theme.fontFamily}", "Noto Sans CJK SC", "Microsoft YaHei"),
  size: 11pt,
  fill: ${theme.textColor},
  lang: "zh"
)

#align(center)[
  #block(
    fill: ${theme.headerFill},
    stroke: 2pt + ${theme.headerStroke},
    radius: 6pt,
    inset: 10pt,
    width: 100%
  )[
    #text(size: 16pt, weight: "bold", fill: ${theme.headerText})[
      ğŸ‘¥ ç©å®¶åˆ—è¡¨ (${data.count} äººåœ¨çº¿)
    ]
  ]
]

#v(8pt)

${playerBlocks}

#v(8pt)

#align(center)[
  #text(size: 8pt, fill: ${theme.statsText})[
    Generated by serverinfo-rest-client Â· ${escapeTypstText(timestamp)}
  ]
]
`
}

export function registerPlayersCommand(
  ctx: Context,
  cfg: Config,
  apiClient: ApiClient,
  logger: any
) {
  ctx.command('mcinfo.players', 'ç©å®¶åˆ—è¡¨')
    .option('mode', '-m <mode:string> è¾“å‡ºæ¨¡å¼ (text/image)')
    .action(async ({ session, options }) => {
      try {
        const data = await apiClient.get<PlayersResponse>('/players')
        const modes = resolveOutputModes(options.mode, cfg)

        const results: h[] = []

        for (const mode of modes) {
          if (mode === 'text') {
            results.push(h.text(formatTextOutput(data, cfg.hidePlayerCoordinates)))
          } else if (mode === 'typst-image') {
            try {
              const renderer = await getTypstRenderer(ctx, cfg, logger)
              const theme = buildTypstTheme(cfg)
              const typstCode = generateTypstCode(data, theme, cfg.hidePlayerCoordinates)
              const pngBuffer = await renderer.toPng(typstCode, cfg.typstRenderScale)
              results.push(h.image(pngBuffer, 'image/png'))
            } catch (err) {
              logger.warn(`Typst æ¸²æŸ“å¤±è´¥: ${err}`)
              results.push(h.text(`[Typst æ¸²æŸ“å¤±è´¥: ${err.message}]\n\n${formatTextOutput(data, cfg.hidePlayerCoordinates)}`))
            }
          }
        }

        if (cfg.quoteCommandReplies && session.messageId) {
          return h('', [h.quote(session.messageId), ...results])
        }
        return results
      } catch (error) {
        logger.error(`è·å–ç©å®¶åˆ—è¡¨å¤±è´¥: ${error}`)
        return `âŒ è·å–ç©å®¶åˆ—è¡¨å¤±è´¥: ${error.message}`
      }
    })
}
