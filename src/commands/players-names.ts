import { Context, h } from 'koishi'
import { Config } from '../config'
import {
  ApiClient,
  resolveOutputModes,
  getTypstRenderer,
  buildTypstTheme,
  escapeTypstText,
} from '../index'

interface PlayersNamesResponse {
  names: string[]
  count: number
}

function formatTextOutput(data: PlayersNamesResponse, label: string): string {
  if (data.count === 0) {
    return `${label} ğŸ“ ç©å®¶ååˆ—è¡¨

å½“å‰æ²¡æœ‰ç©å®¶åœ¨çº¿`
  }

  const nameList = data.names.map((name, i) => `  ${i + 1}. ${name}`).join('\n')
  return `${label} ğŸ“ ç©å®¶ååˆ—è¡¨ (${data.count} äººåœ¨çº¿)

${nameList}`
}

function generateTypstCode(data: PlayersNamesResponse, theme: ReturnType<typeof buildTypstTheme>, label: string): string {
  const timestamp = new Date().toLocaleString('zh-CN')

  if (data.count === 0) {
    return `#set page(
  width: 350pt,
  height: auto,
  margin: (x: 14pt, y: 14pt),
  fill: ${theme.pageBg}
)

#set text(
  font: ("${theme.fontFamily}", "Noto Sans CJK SC", "Microsoft YaHei"),
  size: 11pt,
  fill: ${theme.textColor},
  lang: "zh"
)

#align(center)[
  #block(
    fill: ${theme.headerFill},
    stroke: 2pt + ${theme.headerStroke},
    radius: 6pt,
    inset: 10pt,
    width: 100%
  )[
    #text(size: 16pt, weight: "bold", fill: ${theme.headerText})[
      ${escapeTypstText(label)} ğŸ“ ç©å®¶ååˆ—è¡¨
    ]
  ]
]

#v(8pt)

#block(
  fill: ${theme.panelFill},
  stroke: 1pt + ${theme.panelStroke},
  radius: 4pt,
  inset: 12pt,
  width: 100%
)[
  #align(center)[
    #text(size: 12pt)[å½“å‰æ²¡æœ‰ç©å®¶åœ¨çº¿]
  ]
]

#v(8pt)

#align(center)[
  #text(size: 8pt, fill: ${theme.statsText})[
    Generated by serverinfo-rest-client Â· ${escapeTypstText(timestamp)}
  ]
]
`
  }

  const nameItems = data.names.map((name, i) => 
    `[${i + 1}.], [${escapeTypstText(name)}],`
  ).join('\n    ')

  return `#set page(
  width: 380pt,
  height: auto,
  margin: (x: 14pt, y: 14pt),
  fill: ${theme.pageBg}
)

#set text(
  font: ("${theme.fontFamily}", "Noto Sans CJK SC", "Microsoft YaHei"),
  size: 11pt,
  fill: ${theme.textColor},
  lang: "zh"
)

#align(center)[
  #block(
    fill: ${theme.headerFill},
    stroke: 2pt + ${theme.headerStroke},
    radius: 6pt,
    inset: 10pt,
    width: 100%
  )[
    #text(size: 16pt, weight: "bold", fill: ${theme.headerText})[
      ${escapeTypstText(label)} ğŸ“ ç©å®¶ååˆ—è¡¨ (${data.count} äººåœ¨çº¿)
    ]
  ]
]

#v(8pt)

#block(
  fill: ${theme.panelFill},
  stroke: 1pt + ${theme.panelStroke},
  radius: 4pt,
  inset: 12pt,
  width: 100%
)[
  #table(
    columns: (auto, 1fr),
    stroke: none,
    row-gutter: 6pt,
    ${nameItems}
  )
]

#v(8pt)

#align(center)[
  #text(size: 8pt, fill: ${theme.statsText})[
    Generated by serverinfo-rest-client Â· ${escapeTypstText(timestamp)}
  ]
]
`
}

export function registerPlayersNamesCommand(
  ctx: Context,
  cfg: Config,
  apiClient: ApiClient,
  logger: any,
  prefix: string,
  label: string
) {
  ctx.command(`${prefix}.players-names`, 'ç©å®¶ååˆ—è¡¨')
    .option('mode', '-m <mode:string> è¾“å‡ºæ¨¡å¼ (text/image)')
    .action(async ({ session, options }) => {
      try {
        const data = await apiClient.get<PlayersNamesResponse>('/players/names')
        const modes = resolveOutputModes(options.mode, cfg)

        const results: h[] = []

        for (const mode of modes) {
          if (mode === 'text') {
            results.push(h.text(formatTextOutput(data, label)))
          } else if (mode === 'typst-image') {
            try {
              const renderer = await getTypstRenderer(ctx, cfg, logger)
              const theme = buildTypstTheme(cfg)
              const typstCode = generateTypstCode(data, theme, label)
              const pngBuffer = await renderer.toPng(typstCode, cfg.typstRenderScale)
              results.push(h.image(pngBuffer, 'image/png'))
            } catch (err) {
              logger.warn(`Typst æ¸²æŸ“å¤±è´¥: ${err}`)
              results.push(h.text(`[Typst æ¸²æŸ“å¤±è´¥: ${err.message}]`))
            }
          }
        }

        if (cfg.quoteCommandReplies && session.messageId) {
          return h('', [h.quote(session.messageId), ...results])
        }
        return results
      } catch (error) {
        logger.error(`è·å–ç©å®¶ååˆ—è¡¨å¤±è´¥: ${error}`)
        return `âŒ è·å–ç©å®¶ååˆ—è¡¨å¤±è´¥: ${error.message}`
      }
    })
}
